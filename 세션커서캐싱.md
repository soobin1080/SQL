# 세션 커서 캐싱
하드파싱을 최소화해 시스템 확장성을 높일 수 있다. 그런데 하드 파싱을 하지 않더라도 SQL 구문 분석 > 해시값 계산 > library cache 래치 획득 후 라이브러리 캐시에서 커서를 탐색하는 과정도 부담.
특히, SQL 동시 수행이 많을 때 시스템 부하를 주게 된다.
SQl 수행횟수가 많으면 파싱관련 경합도 많이 발생

### 세션 커서 캐싱 이란?
- Shared Pool 에 위치한 공유 커서를 실행하려고 PGA로 인스턴스화한 것이 세션 커서
- 쿼리 수행 후 커서를 닫으면 **세션 커서를 위해 할당된 메모리**와 **공유 커서를 가리키는 포인터**까지 바로 해제
  이후 같은 SQL 을 수행하면 커서를 오픈하기 위한 라이브러리 캐시 탐색작업을 다시 해야한다.
  오라클에서 자주 수행하는 SQL에 대한 세션 커서를 "세션 커서 캐시"에 저장할 수 있는 **세션 커서 캐싱** 기능 제공
- 세션 커서 캐싱 기능 활성화 방법 : Parse Call 횟수를 확인 후 3보다 크거나 같으면 세션 커서를 세션 커서 캐시로 옮김
- 세션 커서 캐시에는 SQL 텍스트와 함께 공유 커서를 가리키는 포인터 저장
  커서는 닫히 상태지만 공유 커서에 대한 참조 포인터 유지 -> 다음 수행 시 더 빨리 커서 오픈 가능
  -> 자주 수행되는 SQL 문에 의해 발생하는 라이브러리 캐시 부하 경감, CPU 사용량 감소, 소프트 파싱 과정에서 발생하는 패치요청 횟수 감소
- 세션 커서 캐시 내에 LRU 알고리즘 사용 세션 커서 캐싱
하드파싱을 최소화해 시스템 확장성을 높일 수 있다. 그런데 하드 파싱을 하지 않더라도 SQL 구문 분석 > 해시값 계산 > library cache 래치 획득 후 라이브러리 캐시에서 커서를 탐색하는 과정도 부담.
특히, SQL 동시 수행이 많을 때 시스템 부하를 주게 된다.
SQl 수행횟수가 많으면 파싱관련 경합도 많이 발생

- Shared Pool 에 위치한 공유 커서를 실행하려고 PGA로 인스턴스화한 것이 세션 커서
- 쿼리 수행 후 커서를 닫으면 **세션 커서를 위해 할당된 메모리**와 **공유 커서를 가리키는 포인터**까지 바로 해제
  이후 같은 SQL 을 수행하면 커서를 오픈하기 위한 라이브러리 캐시 탐색작업을 다시 해야한다.
  오라클에서 자주 수행하는 SQL에 대한 세션 커서를 "세션 커서 캐시"에 저장할 수 있는 **세션 커서 캐싱** 기능 제공
- 세션 커서 캐싱 기능 활성화 방법 : Parse Call 횟수를 확인 후 3보다 크거나 같으면 세션 커서를 세션 커서 캐시로 옮김
- 세션 커서 캐시에는 SQL 텍스트와 함께 공유 커서를 가리키는 포인터 저장
  커서는 닫히 상태지만 공유 커서에 대한 참조 포인터 유지 -> 다음 수행 시 더 빨리 커서 오픈 가능
  -> 자주 수행되는 SQL 문에 의해 발생하는 라이브러리 캐시 부하 경감, CPU 사용량 감소, 소프트 파싱 과정에서 발생하는 패치요청 횟수 감소
- 세션 커서 캐시 내에 LRU 알고리즘 사용

- session_cached_cursors : 세션 커서를 얼마나 캐싱할지 지정하는 파라미터, 0 보다 크게 설정 시 parse call 이 발생할 때마다 라이브러리 캐시 탐색 전에 세션 커서 캐시를 먼저 살핌.
- 세션 커서 캐시에서 커서를 찾으면 라이브러리 탐색 없이 곧바로 공유 커서를 찾아 커서를 오픈할 수 있다. 공유 커서 pin 설정 후 해제 과정에서 발생하는 라이브러리 래치를 완전히 회피하지는 못함
- v$sql 을 보면 users_opening과 users_executing 이 있다.
  - users_opening : 공유 커서를 참조하고 있는 세션 커서의 수 - 수행 후 세션 커서 캐시로 옮겨지면 users_opening 에 집계 된다.
  - users_executing : 해당 sql을 현재 실행 중인 수 (커서가 열려있는 세션 커서의 수) - DML 일 때는 수행 마칠 때 자동으로 닫히지만, select 문은 EOF(end of fetch)에 도달했을 때 닫힌다.
- 세션 커서 캐싱 기능은 Parse Call 을 대체하기보다 Parse Call의 부하 감소 기능으로 이해하자. 10g 이후 버전에서는 파리미터 값을 0보다 크게 설정하여 세션 커서 캐싱 기능을 활성화한다.
